<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <script src="/viOne/js/jquery/jquery.min.js"></script>
  <script src="/viOne/view/vi_tooltipHelpers.js"></script>

  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="/styles/jquery/ui/1.12.1/themes/base/jquery-ui.css">
  


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<link rel="stylesheet" href="styles.css"> 


</head>
<body>


  <!-- 
    This is a multi-line comment.
    You can add multiple lines of explanation or notes here.
    -->


  <div id="overlay" class="overlay" >
    <button id="startButton" class="start-button">Start</button>
  </div>

  <div id="mapContainer"></div>

  <div id="tooltip" class="tooltip"></div>
  
  <div id="gridview"></div> 

  <div id="menu" class="menu">
    <button id="showMobiles">Show Mobiles</button>
  </div>

 <div id="detail"></div>


 


  <script type="module">



    /*

      IMPORTA LIBRERIAS viONE

    */


    import { vi_ObjectModel, vi_MapFactory, vi_RemoteListenerFactory, vi_ObjectGridView, vi_Controller, vi_DataSource} from '/viOne/all.js';



   // CREA UN CONTROLADOR
      const controller = new vi_Controller();
    
   // CREA UN MODELO DE OBJETOS 
      const objectModel = new vi_ObjectModel(controller);

   // CREA UN MAPA TIPO Cesium
      const mapFactory = new vi_MapFactory();
      const map = mapFactory.createMap("Cesium", controller);
   
   // CREA UNA FABRICA PARA LISTENERS REMOTOS   
      const remoteListenerFactory = new vi_RemoteListenerFactory();


   // CREA UN DATASOURCE para trips
      const tripDataSource = new vi_DataSource('Firebase', './config/firebaseConfig.json');

   // CREA UN DATASOURCE PARA CEDIS   
      const cedisDataSource = new vi_DataSource('GoogleSheet', './config/googlesheetconfig.json');


     
   // Cuando carga el DOM completo
    
    document.addEventListener("DOMContentLoaded", function () {
        
      // Genera ventana de GRID
      vix_tt_formatToolTip("#gridview","Objetos",500,350);

      const gridView = new vi_ObjectGridView('gridview',controller, headerFunction, rowFunction);
        
      // Carga Mapa y activa listener continuo
      map.load().then(()=>{
            const mobilesRemoteListener = remoteListenerFactory.createRemoteListener(tripDataSource,objectModel);
            const cedisRemoteListener = remoteListenerFactory.createRemoteListener(cedisDataSource,objectModel);
          })
   
    });

 
    // AGREGA COMO OBSERVADOR A LA FUNCION BLOC  (BUSINESS LOGC COMPONENT)

    controller.addObserver("objectSelected",BLOC);


    // BLOC : BUSINESS LOGIC 

    function BLOC(event, data){

        var action;

        switch (event) {
        case 'objectSelected':


              let object = objectModel.readObject(data.id);
          
              if(object.collection == 'cedis') {
                console.log("CEDIS SELECCIONADO");

              }
              if(object.collection == 'trips') {
                console.log("TRIP SELECCIONADO");
              } 



           break;

        default:
          throw new Error(`Unsupported event: ${event}`);
        }

        return action;
    }


    function headerFunction(){

      const html = `
      <th style="color: white;">ID</th>
      <th style="color: white;">Collection</th>
      <th style="color: white;">Mobile</th>
      <th style="color: white;">Destino</th>
      <th style="color: white;">Trip State</th>
      <th style="color: white;">Unidad</th>
      `;

      return (html);


    }




    /*

      Funcion que detalla el contenido de cada fila en la tbla de seleccion de mobiles

    */

    function rowFunction(id, collection, data){
      // Extract the significant data fields
      const { destination, tripState, unit } = data;
  
      // Determine the circle color based on tripState
      let circleColor = "red"; // Default circle color
  
      if (tripState === "loading") {
        circleColor = "green"; // Set circle color to green for "In Progress" state
      } else if (tripState === "Completed") {
        circleColor = "blue"; // Set circle color to blue for "Completed" state
      } // Add more conditions for other states if needed
  
      // Create an HTML string for the mobile with significant data and white text color
     

      const html = `
  
    
      <td>
        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
          <circle cx="10" cy="10" r="8" fill="${circleColor}" />
        </svg>
      </td>
      <td style="color: white;">Mobile ${collection}</td>

      <td style="color: white;">Mobile ${id}</td>
      <td style="color: white;">Destino : ${destination}</td>
      <td style="color: white;">Trip State: ${tripState}</td>
      <td style="color: white;">Unidad : ${unit}</td>
    
  
`;

return (html);

    }


   
    vix_tt_formatToolTip("#detail","Detalle",500,300);




      function toggleModelView() {
              var modelView = document.getElementById("modelview");
              if (modelView.style.visibility === "hidden" || modelView.style.visibility === "") {
              modelView.style.visibility = "visible";
              } else {
              modelView.style.visibility = "hidden";
              hidebottom();

              

            
              }
        }

        function hidebottom(){

          const div = document.querySelector(".cesium-viewer-bottom");
              if (div) {
                div.style.display = "none";
              }

              const div1 = document.querySelector(".cesium-viewer-animationContainer");
              if (div1) {
                div1.style.display = "none";
              }

        }


      document.getElementById("showMobiles").onclick = toggleModelView;

      document.getElementById("startButton").addEventListener("click", function() {
          hidebottom();
          document.getElementById("overlay").style.display = "none";
        });

  </script>




   


</body>
</html>